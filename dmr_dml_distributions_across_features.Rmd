---
title: "Distributions of DMLs and DMRs across genomic features"
author: "Cemile Balkas"
date: "2025-07-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Distribution of DMLs and DMRs across genomic features

To investigate where methylation changes occur in the genome, I first quantified the distribution of differentially methylated loci (DMLs) and differentially methylated regions (DMRs) across genomic features such as transcription start sites (TSS), exons, introns, untranslated regions (UTRs), and intergenic regions.

These distributions are based on exclusive feature assignment, where each DML or DMR is assigned to a single genomic feature according to a defined precedence:
`tss > downstream_1kb > 5'UTRs > 3'UTRs > exons > introns > intergenic

This means overlapping regions are counted only once, and features considered to have greater regulatory relevance, such as promoters and untranslated regions, are prioritised over broader categories like intronic or intergenic regions.

The barplots below show the percentage of total DMLs and DMRs overlapping each genomic feature. Both distributions reveal similar patterns: the majority of methylation changes occur in intergenic and intronic regions, with relatively fewer changes observed in promoter associated (TSS) or UTR regions.

This similarity suggests that the regional distribution of methylation changes is largely consistent whether considering individual CpG sites (DMLs) or aggregated regions (DMRs). These patterns are also maintained when DMRs are separated into hypermethylated and hypomethylated categories.

# Plot feature distribution bar graph
```{r}
rotate_x <- function(data, rot_angle, main_title, y_label) {
  colors <- rainbow(length(data))
  plt <- barplot(data,
    xaxt = "n",
    las = 2,
    ylim = c(0, 75),
    main = main_title,
    ylab = y_label,
    xlab = "Genomic Feature",
    col = colors
  )

  text(plt, par("usr")[3],
    labels = names(data),
    srt = rot_angle, adj = c(1.1, 1.1),
    xpd = TRUE, cex = 0.8
  )
  text(plt, data,
    labels = round(data, 1), # Round to 1 decimal if you like
    pos = 3, cex = 0.7
  ) # pos=3 means above bar
}
# same function but more high quality graphics with ggplot2
library(ggplot2)
rotate_x_ggplot <- function(data, rot_angle = 45, main_title = "", y_label = "", title_color = "black") {
  # Convert named vector to data frame
  df <- data.frame(
    Feature = factor(names(data), levels = names(data)),
    Percentage = as.numeric(data)
  )
  
  # Assign rainbow colors
  df$Color <- rainbow(nrow(df))
  
  # Create plot
  ggplot(df, aes(x = Feature, y = Percentage, fill = Feature)) +
    geom_bar(stat = "identity", show.legend = FALSE, lwd = 0.3, color = "black") +
    scale_fill_manual(values = df$Color) +
    geom_text(aes(label = round(Percentage, 1)), vjust = -0.5, size = 3) +
    labs(
      title = main_title,
      x = "Genomic Feature",
      y = y_label
    ) +
    theme_classic() +
    theme(
      plot.title = element_text(color = title_color),
      axis.text.x = element_text(angle = rot_angle, hjust = 1)
    )
}

```

# DMLs
```{r plot-dml-bargraph}
df_dml_feature_counts <- read.csv("dml_feature_overlap_output/overlap_counts_exclusive.csv")
total_cpg <- sum(df_dml_feature_counts$All_CpG_Count)

# df_dml_feature_counts$Percent_of_Total_CpGs <- round(100 * df_dml_feature_counts$All_CpG_Count / total_cpg, 2)

# Calculate total DMLs
df_dml_feature_counts$TotalDMLs <- df_dml_feature_counts$HyperDMLs + df_dml_feature_counts$HypoDMLs

# Compute percentage of total DMLs
total_dmls <- sum(df_dml_feature_counts$TotalDMLs)
df_dml_feature_counts$Percent_of_DMLs <- round(100 * df_dml_feature_counts$TotalDMLs / total_dmls, 2)
# set custom order for the barplots
custom_order <- c("tss", "5utrs", "exons", "introns", "3utrs", "downstream_1kb", "intergenic")

# Create vector for plotting
dml_percentages <- setNames(df_dml_feature_counts$Percent_of_DMLs, df_dml_feature_counts$Feature)
dml_percentages <- dml_percentages[custom_order]

# Use custom plot function
# rotate_x(dml_percentages, rot_angle = 45, main_title = "DML distribution across genomic features", y_label ="Percentage of DMLs (%)")
rotate_x_ggplot(dml_percentages, rot_angle = 45, main_title = "DML distribution across genomic features", y_label ="Percentage of DMLs (%)")

# --------------

total_hyper_dmls <- sum(df_dml_feature_counts$HyperDMLs)
hyper_dml_counts <- df_dml_feature_counts$HyperDMLs
names(hyper_dml_counts) <- df_dml_feature_counts$Feature

# Calculate percentages
dml_percentages <- round(100 * hyper_dml_counts / total_hyper_dmls, 2)

# Define order for plot
custom_order <- c("tss", "5utrs", "exons", "introns", "3utrs", "downstream_1kb", "intergenic")

# Reorder the dmr_percentages vector
dml_percentages <- dml_percentages[custom_order]

label_map <- c(
  tss = "TSS",
  `5utrs` = "5′ UTR",
  exons = "Exons",
  introns = "Introns",
  `3utrs` = "3′ UTR",
  downstream_1kb = "Downstream (1kb)",
  intergenic = "Intergenic"
)

# Rename dmr_percentages using label_map
names(dml_percentages) <- label_map[names(dml_percentages)]
rotate_x_ggplot(dml_percentages, rot_angle = 45, main_title = "Hyper DML distribution across genomic features", y_label ="Percentage of Hyper DMLs (%)", title_color = "#CD2626")
ggsave("analysis_results/DML_HYPER_genomic_feature_distribution.png")

# --------------

total_hypo_dmls <- sum(df_dml_feature_counts$HypoDMLs)
hypo_dml_counts <- df_dml_feature_counts$HypoDMLs
names(hypo_dml_counts) <- df_dml_feature_counts$Feature

# Calculate percentages
dml_percentages <- round(100 * hypo_dml_counts / total_hypo_dmls, 2)

# Define order for plot
custom_order <- c("tss", "5utrs", "exons", "introns", "3utrs", "downstream_1kb", "intergenic")

# Reorder the dmr_percentages vector
dml_percentages <- dml_percentages[custom_order]

# Rename dmr_percentages using label_map
names(dml_percentages) <- label_map[names(dml_percentages)]
rotate_x_ggplot(dml_percentages, rot_angle = 45, main_title = "Hypo DML distribution across genomic features", y_label ="Percentage of Hypo DMLs (%)", title_color = "#3A5FCD")
# ggsave("analysis_results/DML_dist_hypo.png", width = 5, height = 6, units = "in")
ggsave("analysis_results/DML_HYPO_genomic_feature_distribution.png")


```

# DMRs
## Load DMRs in Feature overlap files and visualise in bar graph

```{r plot-feature-dmr-dist}
# Read the total DMRs file (dss dmr output all dmrs)
total_dmrs <- nrow(read.delim("HG38_24_06_2025_HCT116_3BKO_TIDY_VS_HCT116_WT_TIDY_DMRs.bed", header = FALSE))

# Get list of overlap files (from the bash script that overlapped dmrs with genomic features using bedtools)
# overlap_dir <- "dmr_only_feature_overlaps"
overlap_dir <- "dmr_only_feature_overlaps_exclusive"
files <- list.files(overlap_dir, pattern = "^all_dmrs_in_.*\\.bed$", full.names = TRUE)

# Count overlaps
dmr_counts <- sapply(files, function(file) {
  nrow(read.delim(file, header = FALSE))
})

# Extract and clean feature names
names(dmr_counts) <- gsub("^all_dmrs_in_|\\.bed$", "", basename(names(dmr_counts)))

# Define order for plot
custom_order <- c("tss", "5utrs", "exons", "introns", "3utrs", "downstream_1kb", "intergenic")

# Calculate percentages
dmr_percentages <- round(100 * dmr_counts / total_dmrs, 2)

# Reorder the dmr_percentages vector
dmr_percentages <- dmr_percentages[custom_order]

label_map <- c(
  tss = "TSS",
  `5utrs` = "5′ UTR",
  exons = "Exons",
  introns = "Introns",
  `3utrs` = "3′ UTR",
  downstream_1kb = "Downstream (1kb)",
  intergenic = "Intergenic"
)

# Rename dmr_percentages using label_map
names(dmr_percentages) <- label_map[names(dmr_percentages)]

# png(filename="analysis_results/DMR_genomic_feature_distribution.png", width = 600, height = 380)

# Plot with the custom rotate_x function
rotate_x_ggplot(dmr_percentages, rot_angle = 45, main_title = "DMR distribution across genomic features", y_label ="Percentage of DMRs (%)")

# dev.off()

```

```{r plot-feature-dmr-hyper}
# Read the total DMRs file (dss dmr output all dmrs)
total_hyper_dmrs <- nrow(read.delim("HG38_24_06_2025_HCT116_3BKO_TIDY_VS_HCT116_WT_TIDY_DMRs_HYPER.bed", header = FALSE))

# Get list of overlap files (from the bash script that overlapped dmrs with genomic features using bedtools)
overlap_dir <- "dmr_feature_overlaps_exclusive"
hyper_files <- list.files(overlap_dir, pattern = "^hyper_dmrs_in_.*\\.bed$", full.names = TRUE)
# Count overlaps
dmr_counts <- sapply(hyper_files, function(file) {
  nrow(read.delim(file, header = FALSE))
})

# Extract and clean feature names
names(dmr_counts) <- gsub("^hyper_dmrs_in_|\\.bed$", "", basename(names(dmr_counts)))

# Define order for plot
custom_order <- c("tss", "5utrs", "exons", "introns", "3utrs", "downstream_1kb", "intergenic")

# Calculate percentages
dmr_percentages <- round(100 * dmr_counts / total_hyper_dmrs, 2)

# Reorder the dmr_percentages vector
dmr_percentages <- dmr_percentages[custom_order]

label_map <- c(
  tss = "TSS",
  `5utrs` = "5′ UTR",
  exons = "Exons",
  introns = "Introns",
  `3utrs` = "3′ UTR",
  downstream_1kb = "Downstream (1kb)",
  intergenic = "Intergenic"
)

# Rename dmr_percentages using label_map
names(dmr_percentages) <- label_map[names(dmr_percentages)]

# png(filename="analysis_results/DMR_HYPER_genomic_feature_distribution.png", width = 600, height = 380)

# Plot with the custom rotate_x function
rotate_x(dmr_percentages, rot_angle = 45, main_title = "Hypermethylated DMR distribution across genomic features", y_label ="Hypermethylated DMRs (%)")
rotate_x_ggplot(dmr_percentages, rot_angle = 45, main_title = "Hypermethylated DMR distribution across genomic features", y_label ="Hypermethylated DMRs (%)", title_color = "#CD2626")
ggsave("analysis_results/DMR_HYPER_genomic_feature_distribution.png")
# dev.off()

```


```{r plot-feature-dmr-hypo}
# Read the total DMRs file (dss dmr output all dmrs)
total_hypo_dmrs <- nrow(read.delim("HG38_24_06_2025_HCT116_3BKO_TIDY_VS_HCT116_WT_TIDY_DMRs_HYPO.bed", header = FALSE))

# Get list of overlap files (from the bash script that overlapped dmrs with genomic features using bedtools)
overlap_dir <- "dmr_feature_overlaps_exclusive"
hypo_files <- list.files(overlap_dir, pattern = "^hypo_dmrs_in_.*\\.bed$", full.names = TRUE)
# Count overlaps
dmr_counts <- sapply(hypo_files, function(file) {
  nrow(read.delim(file, header = FALSE))
})

# Extract and clean feature names
names(dmr_counts) <- gsub("^hypo_dmrs_in_|\\.bed$", "", basename(names(dmr_counts)))

# Define order for plot
custom_order <- c("tss", "5utrs", "exons", "introns", "3utrs", "downstream_1kb", "intergenic")

# Calculate percentages
dmr_percentages <- round(100 * dmr_counts / total_hypo_dmrs, 2)

# Reorder the dmr_percentages vector
dmr_percentages <- dmr_percentages[custom_order]

label_map <- c(
  tss = "TSS",
  `5utrs` = "5′ UTR",
  exons = "Exons",
  introns = "Introns",
  `3utrs` = "3′ UTR",
  downstream_1kb = "Downstream (1kb)",
  intergenic = "Intergenic"
)

# Rename dmr_percentages using label_map
names(dmr_percentages) <- label_map[names(dmr_percentages)]


# png(filename="analysis_results/DMR_HYPO_genomic_feature_distribution.png", width = 600, height = 380)

# Plot with the custom rotate_x function
rotate_x(dmr_percentages, rot_angle = 45, main_title = "Hypomethlated DMR distribution across genomic features", y_label ="Hypomethylated DMRs (%)")

rotate_x_ggplot(dmr_percentages, rot_angle = 45, main_title = "Hypomethlated DMR distribution across genomic features", y_label ="Hypomethylated DMRs (%)", title_color = "#3A5FCD")
ggsave("analysis_results/DMR_HYPO_genomic_feature_distribution.png")

# dev.off()

```


